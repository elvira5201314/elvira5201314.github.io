    // --- 新增：安全驗證邏輯 ---

    // 開啟驗證彈窗 (接收動作類型：'save' 或 'delete')
    function showAuthModal(actionType) {
        pendingAction = actionType; // 設定待執行的動作
        
        const titleEl = document.getElementById('auth-title');
        const descEl = document.getElementById('auth-desc');
        
        // 根據動作類型顯示不同標題
        if (actionType === 'save') {
            titleEl.innerText = '安全驗證';
            descEl.innerText = '修改敏感資料需輸入管理密碼';
        } else if (actionType === 'delete') {
            titleEl.innerText = '刪除確認';
            descEl.innerText = '刪除此筆資料需輸入管理密碼';
        }

        document.getElementById('auth-password').value = ''; // 清空密碼
        
        const modal = document.getElementById('auth-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        
        // 自動聚焦
        setTimeout(() => document.getElementById('auth-password').focus(), 100);
    }

    // 關閉驗證彈窗
    function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
        pendingAction = null; // 清除待辦
    }

    // 處理驗證確認
    async function handleAuthConfirm() {
        const btn = document.getElementById('auth-confirm-btn');
        const originalText = btn.innerHTML;
        const password = document.getElementById('auth-password').value;
        
        if (!password) {
            showToast('請輸入密碼', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // 驗證密碼
            const { error } = await _supabase.auth.signInWithPassword({
                email: 'elvira5201314@gmail.com',
                password: password
            });

            if (error) throw error;

            // 驗證成功
            closeAuthModal();
            
            // 根據剛剛設定的動作，執行對應函式
            setTimeout(() => {
                if (pendingAction === 'save') executeSave();
                else if (pendingAction === 'delete') executeDelete();
            }, 300);

        } catch (error) {
            console.error(error);
            showToast('密碼錯誤', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // 強制修正儲存按鈕的點擊事件 (確保按鈕呼叫 saveChanges)
    document.addEventListener('DOMContentLoaded', () => {
        const saveBtn = document.getElementById('btn-save');
        if (saveBtn) {
            saveBtn.removeAttribute('onclick');
            saveBtn.onclick = saveChanges;
        }
    });

    // 點擊「儲存變更」按鈕 (檢查變更內容)
    function saveChanges() {
        let sensitiveChanged = false;
        let notesChanged = false;
        let hasChanges = false;

        document.querySelectorAll('.edit-mode').forEach(input => {
            const key = input.dataset.key;
            if (!key) return;
            
            let originalValue = currentItem[key];
            if (originalValue === null || originalValue === undefined) originalValue = '';
            
            let newValue = input.value;
            
            if (String(originalValue).trim() !== String(newValue).trim()) {
                hasChanges = true;
                if (key === 'notes') {
                    notesChanged = true;
                } else {
                    sensitiveChanged = true;
                }
            }
        });

        if (!hasChanges) {
            showToast('未偵測到任何變更', 'info');
            // 如果沒變更，重新載入 Modal 回到檢視模式
            openModal(currentItem.id);
            return;
        }

        if (sensitiveChanged) {
            // 改了敏感資料 -> 傳入 'save' 字串告訴 Modal 這是儲存動作
            showAuthModal('save');
        } else {
            // 只改備註 -> 直接存
            executeSave();
        }
    }

    // 點擊「刪除」按鈕
    function requestDelete() {
        // 傳入 'delete' 字串告訴 Modal 這是刪除動作
        showAuthModal('delete');
    }

    // 真正的儲存執行函式
    async function executeSave() {
        const btn = document.getElementById('btn-save');
        if (!btn) return;
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> 儲存中...';
            btn.disabled = true;
            lucide.createIcons();

            const updates = {};
            document.querySelectorAll('.edit-mode').forEach(input => {
                const key = input.dataset.key;
                if (key) updates[key] = input.value;
            });

            const { error } = await _supabase
                .from('service_contracts')
                .update(updates)
                .eq('id', currentItem.id);

            if (error) throw error;

            showToast('資料已更新', 'success');
            closeModal();
            loadData();

        } catch (error) {
            console.error('Save Error:', error);
            showToast('儲存失敗: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // 執行刪除
    async function executeDelete() {
        const { error } = await _supabase
            .from('service_contracts')
            .delete()
            .eq('id', currentItem.id);

        if (error) {
            showToast('刪除失敗: ' + error.message, 'error');
        } else {
            showToast('已刪除該筆資料', 'success');
            closeModal();
            loadData();
        }
    }

    // Toast 提示
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        const bgClass = type === 'success' ? 'bg-[#06C755]' : 'bg-red-500';
        const icon = type === 'success' ? 'check-circle' : 'alert-circle';
        
        el.className = `${bgClass} text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 transform translate-y-[-20px] opacity-0 transition-all duration-300 font-bold tracking-wide`;
        el.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i> ${message}`;
        
        container.appendChild(el);
        lucide.createIcons();

        requestAnimationFrame(() => {
            el.classList.remove('translate-y-[-20px]', 'opacity-0');
        });

        setTimeout(() => {
            el.classList.add('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    }

    // 點擊背景關閉彈窗
    document.getElementById('detail-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('detail-modal')) closeModal();
    });
