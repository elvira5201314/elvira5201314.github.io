<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>èŒå¯µç•¶å®¶ | å¾Œå°ç®¡ç†ç³»çµ±</title>
    
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">

    <!-- PWA Admin è¨­å®š -->
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#D88E99">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw-admin.js');
            });
        }
    </script>

    <!-- å¼•å…¥èˆ‡é¦–é ç›¸åŒçš„å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@300;400;500;700;900&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = { 
            theme: {
                extend: {
                    colors: {
                        theme: {
                            bg: '#FAF8F5',
                            rose: '#D88E99',
                            roseDeep: '#B56576',
                            gold: '#C5A065',
                            goldLight: '#E5CFA0',
                            text: '#4A4238',
                            sub: '#8C857B',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        en: ['"Cormorant Garamond"', 'serif'],
                    },
                    backgroundImage: {
                        'gradient-lux': 'linear-gradient(135deg, #D88E99 0%, #C5A065 100%)',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            background-color: #FAF8F5;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(216, 142, 153, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(197, 160, 101, 0.08) 0%, transparent 40%);
            font-family: 'Noto Serif TC', serif; 
            color: #4A4238;
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass-panel { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px 0 rgba(74, 66, 56, 0.08);
        }

        .input-minimal {
            width: 100%;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(140, 133, 123, 0.2);
            padding: 0.8rem 1rem;
            border-radius: 12px;
            color: #4A4238;
            transition: all 0.3s;
        }
        .input-minimal:focus {
            background: #FFFFFF;
            border-color: #D88E99;
            outline: none;
            box-shadow: 0 4px 12px rgba(216, 142, 153, 0.15);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* å‹•ç•« */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: .6; }
        }
        .skeleton-card { animation: pulse-slow 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="fixed top-5 left-0 right-0 z-[100] flex flex-col items-center space-y-2 pointer-events-none px-4"></div>

    <!-- ç™»å…¥ç•«é¢ -->
<div id="login-view" class="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
        <div class="absolute -top-24 -right-24 w-96 h-96 bg-theme-rose/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-24 -left-24 w-96 h-96 bg-theme-gold/10 rounded-full blur-3xl"></div>

        <div class="glass-panel p-10 rounded-[32px] w-full max-w-sm text-center space-y-8 relative z-10">
            <div class="mx-auto w-24 h-24 rounded-full bg-white p-2 shadow-xl border border-white/50 -mt-20 mb-6 flex items-center justify-center">
                <img src="logo.png" alt="Logo" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <i data-lucide="dog" class="hidden w-10 h-10 text-theme-rose"></i>
            </div>

            <div class="space-y-2">
                <h1 class="text-3xl font-black text-theme-text tracking-widest">èŒå¯µç•¶å®¶</h1>
                <p class="text-xs text-theme-sub font-bold tracking-[0.2em] uppercase">Admin Dashboard</p>
            </div>

            <div class="flex p-1.5 bg-white/50 backdrop-blur-md rounded-2xl border border-white/60 shadow-inner">
                <button onclick="switchRole('admin')" id="role-admin" class="flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 bg-white text-theme-rose shadow-sm border border-theme-rose/20">
                    <i data-lucide="crown" class="w-4 h-4"></i> ç®¡ç†å“¡
                </button>
                <button onclick="switchRole('staff')" id="role-staff" class="flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 text-theme-sub hover:bg-white/40">
                    <i data-lucide="user" class="w-4 h-4"></i> å“¡å·¥
                </button>
            </div>

            <div class="relative group">
                <i data-lucide="lock" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50 group-focus-within:text-theme-rose transition-colors"></i>
                <input type="password" id="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" 
                       class="input-minimal pl-12 text-center tracking-widest"
                       onkeydown="if(event.key==='Enter') document.getElementById('login-btn').click()">
            </div>

            <button id="login-btn" onclick="handleLogin(event)" class="w-full py-4 bg-gradient-lux text-white font-bold rounded-xl shadow-lg shadow-theme-rose/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-base hover:-translate-y-1">
                ç™»å…¥ç³»çµ± <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
    <!-- ä¸»æ§å°ç•«é¢ -->
    <div id="dashboard-view" class="hidden min-h-screen pb-24">
        
        <!-- é ‚éƒ¨å°èˆªåˆ— -->
        <nav class="bg-white/60 backdrop-blur-xl border-b border-white/40 sticky top-0 z-40">
            <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-theme-rose/10 flex items-center justify-center text-theme-rose border border-theme-rose/20">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-lg text-theme-text tracking-widest hidden sm:inline">å¾Œå°ç®¡ç†</span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="openChangePasswordModal()" class="text-xs font-bold text-theme-text hover:text-theme-rose px-3 py-2 rounded-lg hover:bg-theme-rose/5 transition flex items-center gap-1.5" title="è®Šæ›´å¯†ç¢¼">
                        <i data-lucide="key-round" class="w-4 h-4"></i> <span class="hidden sm:inline">è®Šæ›´å¯†ç¢¼</span>
                    </button>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <button onclick="handleLogout()" class="text-xs font-bold text-theme-sub hover:text-theme-rose px-3 py-2 rounded-lg hover:bg-theme-rose/5 transition flex items-center gap-1.5">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡º
                    </button>
                </div>
                    </nav>

        <div class="max-w-4xl mx-auto p-6 space-y-6">
            
            <!-- æ¨™é¡Œèˆ‡æœå°‹ -->
            <div class="flex flex-col md:flex-row gap-4 justify-between items-end md:items-center">
                <div>
                    <h2 class="text-2xl font-black text-theme-text tracking-wider">ç¾å®¹å¥‘ç´„åˆ—è¡¨</h2>
                    <p class="text-xs text-theme-sub mt-1 tracking-wide">Service Contracts</p>
                </div>
                <div class="relative w-full md:w-64 group">
                    <i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50 group-focus-within:text-theme-rose transition-colors"></i>
                    <input type="search" id="search-input" placeholder="æœå°‹å¯µç‰©åã€ä¸»äººå§“åã€é›»è©±..." 
                           class="input-minimal pl-10 py-2.5 text-sm bg-white/80">
                </div>
            </div>

            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="content-area" class="space-y-3">
                <div class="text-center py-10 text-theme-sub/50">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è©³æƒ…/ç·¨è¼¯å½ˆçª— -->
    <div id="detail-modal" class="fixed inset-0 bg-theme-text/20 hidden z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-[#FAF8F5] w-full max-w-3xl rounded-t-[32px] sm:rounded-[32px] flex flex-col shadow-2xl transform transition-transform duration-300 max-h-[90vh] border border-white/50" id="modal-panel">
            
            <!-- å½ˆçª—æ¨™é¡Œ -->
            <div class="p-6 border-b border-theme-sub/10 flex justify-between items-center bg-white/50 rounded-t-[32px] shrink-0">
                <div>
                    <h2 class="text-xl font-black text-theme-text tracking-wider">åˆç´„è©³æƒ…</h2>
                    <span class="text-[10px] text-theme-sub uppercase tracking-widest font-bold" id="modal-id">ID: #0000</span>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-theme-sub hover:text-theme-rose hover:shadow-md transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- å½ˆçª—å…§å®¹ -->
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-6 bg-[#FAF8F5]" id="modal-content">
                <!-- JS å‹•æ…‹å¡«å…¥ -->
            </div>
            
            <!-- å½ˆçª—åº•éƒ¨æŒ‰éˆ• -->
            <div class="p-5 border-t border-theme-sub/10 bg-white/80 backdrop-blur rounded-b-none sm:rounded-b-[32px] flex justify-between items-center gap-3 shrink-0">
                <button onclick="requestDelete()" class="text-red-400 font-bold px-4 py-3 hover:bg-red-50 rounded-xl transition active:scale-95 flex items-center gap-2 text-sm">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤
                </button>
                <div class="flex gap-3 flex-1 justify-end">
                    <button onclick="enableEdit()" id="btn-edit" class="bg-white border border-theme-sub/20 text-theme-text px-6 py-3 rounded-xl font-bold hover:border-theme-rose hover:text-theme-rose transition active:scale-95 shadow-sm">
                        ç·¨è¼¯è³‡æ–™
                    </button>
                    <button onclick="saveChanges()" id="btn-save" class="hidden bg-theme-text text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition active:scale-95 shadow-lg flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- è®Šæ›´å¯†ç¢¼å½ˆçª— -->
<div id="change-pwd-modal" class="fixed inset-0 bg-theme-text/40 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-[24px] w-full max-w-[400px] shadow-2xl transform scale-95 transition-transform duration-300 relative">
            <button onclick="closeChangePasswordModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition"><i data-lucide="x" class="w-5 h-5"></i></button>

            <h3 class="text-xl font-bold text-theme-text mb-6 tracking-wider font-serif text-center">å¸³è™Ÿå¯†ç¢¼è®Šæ›´</h3>

            <div id="cp-role-selector" class="flex p-1 bg-gray-100 rounded-xl mb-6 hidden">
                <button onclick="switchCpTarget('admin')" id="cp-target-admin" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-theme-text shadow-sm">ç®¡ç†å“¡ (è‡ªå·±)</button>
                <button onclick="switchCpTarget('staff')" id="cp-target-staff" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-theme-sub hover:bg-white/50">ä¸€èˆ¬å“¡å·¥</button>
            </div>

            <div class="space-y-4">
                <input type="password" id="cp-old-password" placeholder="è«‹è¼¸å…¥è©²å¸³è™ŸèˆŠå¯†ç¢¼" class="w-full bg-[#FAF8F5] border border-transparent focus:bg-white focus:border-theme-rose/30 rounded-xl py-3 px-4 text-center text-sm outline-none transition-all tracking-widest">
                <div class="h-px bg-gray-100 mx-4"></div>
                <input type="password" id="cp-new-password" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘6ä½)" class="w-full bg-[#FAF8F5] border border-transparent focus:bg-white focus:border-theme-rose/30 rounded-xl py-3 px-4 text-center text-sm outline-none transition-all tracking-widest">
                <input type="password" id="cp-confirm-password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" class="w-full bg-[#FAF8F5] border border-transparent focus:bg-white focus:border-theme-rose/30 rounded-xl py-3 px-4 text-center text-sm outline-none transition-all tracking-widest">
            </div>

            <button onclick="handleChangePassword()" id="btn-change-pwd" class="w-full mt-8 py-3 bg-theme-text text-white font-bold rounded-xl shadow-lg active:scale-95 transition text-sm flex items-center justify-center gap-2">
                ç¢ºèªä¿®æ”¹
            </button>
        </div>
    </div>
    
    <!-- é€šç”¨å¯†ç¢¼é©—è­‰å½ˆçª— -->
    <div id="auth-modal" class="fixed inset-0 bg-theme-text/40 hidden z-[70] flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-[32px] w-full max-w-xs text-center space-y-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="mx-auto w-16 h-16 rounded-full bg-theme-text/5 flex items-center justify-center text-theme-text mb-2">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            
            <div class="space-y-2">
                <h3 class="text-xl font-black text-theme-text" id="auth-title">å®‰å…¨é©—è­‰</h3>
                <p class="text-sm text-theme-sub font-medium" id="auth-desc">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
            </div>

            <div class="relative group text-left">
                <i data-lucide="key" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                <input type="password" id="auth-password" placeholder="è¼¸å…¥å¯†ç¢¼" 
                       class="input-minimal pl-10 text-center tracking-widest bg-gray-50 border-gray-200"
                       onkeydown="if(event.key==='Enter') handleAuthConfirm()">
            </div>

            <div class="flex gap-3">
                <button onclick="closeAuthModal()" class="flex-1 py-3 bg-gray-100 text-theme-sub font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button onclick="handleAuthConfirm()" id="auth-confirm-btn" class="flex-1 py-3 bg-theme-text text-white font-bold rounded-xl shadow-lg shadow-theme-text/20 active:scale-95 transition">
                    ç¢ºèª
                </button>
            </div>
        </div>
    </div>

<script>
    // åˆå§‹åŒ– icon
    lucide.createIcons();

    // --- æª¢æŸ¥æ˜¯å¦å‰›ä¿®æ”¹å®Œå¯†ç¢¼ ---
    if (localStorage.getItem('pwd_changed')) {
        setTimeout(() => {
            showToast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼Œè«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥', 'success');
        }, 500);
        localStorage.removeItem('pwd_changed');
    }
    
    // --- Supabase è¨­å®š ---
    const SUPABASE_URL = 'https://anzxwdphcxafxsglomez.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFuenh3ZHBoY3hhZnhzZ2xvbWV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MjU2MzUsImV4cCI6MjA4NDMwMTYzNX0.i6ZHUO7UGz8AbAUz7fPHavYxKG1O-UE4k7Xr2VqP9xc';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- å…¨åŸŸè®Šæ•¸èˆ‡å¸³è™Ÿè¨­å®š ---
    let fullDataList = [];
    let currentItem = null;
    let pendingAction = null;
    
    // ğŸŒŸ ç•¶å‰ç™»å…¥èº«åˆ† ('admin' æˆ– 'staff')
    let currentRole = 'admin'; 
    // ğŸŒŸ ä¿®æ”¹å¯†ç¢¼çš„ç›®æ¨™å°è±¡
    let cpTargetRole = 'admin';

    // ğŸŒŸ å¸³è™Ÿè¨­å®š (è«‹ç¢ºèª Supabase Auth ä¸­æœ‰é€™å…©çµ„å¸³è™Ÿ)
    const ACCOUNTS = {
        admin: 'elvira5201314@gmail.com',
        staff: 'staff@elvira.com'
    };

    // --- 1. ç™»å…¥èˆ‡æ¬Šé™é‚è¼¯ ---

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ (è‡ªå‹•åˆ¤æ–·èº«åˆ†)
    async function checkSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) {
            if (session.user.email === ACCOUNTS.staff) {
                currentRole = 'staff';
            } else {
                currentRole = 'admin';
            }
            showDashboard();
        }
    }
    checkSession();

    // åˆ‡æ›ç™»å…¥èº«åˆ† (UIè®Šæ›´)
    function switchRole(role) {
        currentRole = role;
        const btnAdmin = document.getElementById('role-admin');
        const btnStaff = document.getElementById('role-staff');
        const input = document.getElementById('password');

        // é‡ç½®æ¨£å¼
        const activeClass = "bg-white text-theme-rose shadow-sm border border-theme-rose/20";
        const inactiveClass = "text-theme-sub hover:bg-white/40 border-transparent";

        if (role === 'admin') {
            btnAdmin.className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 ${activeClass}`;
            btnStaff.className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 ${inactiveClass}`;
            input.placeholder = "è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼";
        } else {
            btnStaff.className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 ${activeClass}`;
            btnAdmin.className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 ${inactiveClass}`;
            input.placeholder = "è«‹è¼¸å…¥å“¡å·¥å¯†ç¢¼";
        }
        input.value = '';
        input.focus();
    }

    // åŸ·è¡Œç™»å…¥
    async function handleLogin(event) {
        const btn = document.getElementById('login-btn');
        const originalBtnHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i>';
        lucide.createIcons();

        const password = document.getElementById('password').value;
        const email = ACCOUNTS[currentRole]; // æ ¹æ“šé¸æ“‡çš„èº«åˆ†æŠ“ Email

        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
            return;
        }

        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
            document.getElementById('password').value = '';
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        } else {
            showToast(`${currentRole === 'admin' ? 'åº—é•·' : 'å“¡å·¥'}ç™»å…¥æˆåŠŸï¼`, 'success');
            showDashboard();
        }
    }

    // ç™»å‡º
    async function handleLogout() {
        await _supabase.auth.signOut();
        location.reload();
    }

    // é¡¯ç¤ºä¸»æ§å°
    function showDashboard() {
        document.getElementById('login-view').classList.add('hidden'); 
        document.getElementById('dashboard-view').classList.remove('hidden'); 
        loadData(); 
    }

    // --- 2. è³‡æ–™è¼‰å…¥èˆ‡æ¸²æŸ“ ---

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
        const container = document.getElementById('content-area');
        
        // éª¨æ¶å±
        container.innerHTML = Array(5).fill(0).map(() => `
            <div class="glass-panel p-4 rounded-2xl flex justify-between items-center skeleton-card">
                <div class="space-y-2 w-1/2">
                    <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                    <div class="h-6 bg-gray-200 rounded w-2/3"></div>
                </div>
                <div class="h-8 w-20 bg-gray-200 rounded-lg"></div>
            </div>
        `).join('');

        const { data, error } = await _supabase
            .from('service_contracts')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<div class="text-center text-red-400 py-10">è®€å–éŒ¯èª¤: ${error.message}</div>`;
            return;
        }

        fullDataList = data;
        renderDataList(data);
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderDataList(data) {
        const container = document.getElementById('content-area');
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-20 h-20 bg-theme-sub/5 rounded-full flex items-center justify-center mx-auto mb-4">
                         <i data-lucide="file-x" class="w-10 h-10 text-theme-sub/30"></i>
                    </div>
                    <p class="text-theme-sub font-bold">æš«ç„¡è³‡æ–™</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        container.innerHTML = data.map((item, index) => {
            const date = new Date(item.created_at).toLocaleString('zh-TW', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            // åˆ¤æ–·æ¨™ç±¤
            const hasRisk = item.risk_factors && item.risk_factors.length > 0;
            const riskTag = hasRisk ? 
                `<span class="px-2 py-0.5 rounded-md bg-red-100 text-red-500 text-[10px] font-bold whitespace-nowrap">é«˜é¢¨éšª</span>` : '';

            const hasNotes = item.notes && item.notes.trim().length > 0;
            const noteTag = hasNotes ? 
                `<span class="px-2 py-0.5 rounded-md bg-purple-100 text-purple-600 text-[10px] font-bold flex items-center gap-1 whitespace-nowrap"><i data-lucide="sticky-note" class="w-3 h-3"></i> å‚™è¨»</span>` : '';

            const tagsHtml = (riskTag || noteTag) ? 
                `<div class="flex items-center gap-2 flex-wrap mt-1">${riskTag}${noteTag}</div>` : '';

            return `
            <div onclick="openModal('${item.id}')" class="glass-panel p-5 rounded-2xl flex justify-between items-center cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all group border-l-4 border-l-transparent hover:border-l-theme-rose">
                <div class="flex items-center gap-4 w-full overflow-hidden">
                    <div class="w-12 h-12 rounded-full bg-theme-gold/10 text-theme-gold flex items-center justify-center font-bold text-lg shrink-0">
                        ${item.pet_name ? item.pet_name[0] : '?'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-theme-text text-lg truncate">${item.pet_name}</h3>
                            <span class="text-xs text-theme-sub truncate">(${item.owner_name})</span>
                        </div>
                        ${tagsHtml}
                        <div class="flex items-center gap-3 mt-2 text-xs text-theme-sub font-medium truncate">
                            <span class="flex items-center gap-1"><i data-lucide="scissors" class="w-3 h-3"></i> ${item.service_type || 'æœªæŒ‡å®š'}</span>
                            <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${date}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right hidden sm:block pl-4 shrink-0">
                    <span class="text-xs font-bold text-theme-rose border border-theme-rose/30 px-3 py-1 rounded-full group-hover:bg-theme-rose group-hover:text-white transition-colors">
                        æŸ¥çœ‹
                    </span>
                </div>
            </div>`;
        }).join('');
        lucide.createIcons();
    }

    // æœå°‹åŠŸèƒ½
    document.getElementById('search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = fullDataList.filter(item => 
            (item.owner_name && item.owner_name.includes(term)) ||
            (item.owner_phone && item.owner_phone.includes(term)) ||
            (item.pet_name && item.pet_name.includes(term))
        );
        renderDataList(filtered);
    });

    // --- 3. è©³æƒ…å½ˆçª—èˆ‡ç·¨è¼¯ ---

    // é–‹å•Ÿè©³æƒ…å½ˆçª— (åŒ…å«æ¬Šé™åˆ¤æ–·)
    function openModal(id) {
        currentItem = fullDataList.find(i => i.id == id);
        if (!currentItem) return;

        const idStr = String(currentItem.id);
        document.getElementById('modal-id').innerText = `ID: #${idStr.length > 8 ? idStr.substring(0, 8) : idStr}`;
        const content = document.getElementById('modal-content');
        
        // å®šç¾©é¡¯ç¤ºæ¬„ä½
        const sections = [
            { title: 'ğŸ‘¤ é£¼ä¸»è³‡æ–™', fields: [{label:'å§“å',key:'owner_name'}, {label:'é›»è©±',key:'owner_phone'}, {label:'Email',key:'owner_email'}, {label:'èº«åˆ†è­‰',key:'owner_id'}, {label:'åœ°å€',key:'owner_address',full:true}] },
            { title: 'ğŸš‘ ç·Šæ€¥è¯çµ¡', fields: [{label:'è¯çµ¡äºº',key:'emergency_name'}, {label:'ç·Šæ€¥é›»è©±',key:'emergency_phone'}, {label:'æŒ‡å®šé†«é™¢',key:'hospital',full:true}] },
            { title: 'ğŸ¾ å¯µç‰©è³‡æ–™', fields: [{label:'åå­—',key:'pet_name'}, {label:'å“ç¨®',key:'pet_breed'}, {label:'èŠ±è‰²',key:'pet_color'}, {label:'å¹´é½¡',key:'pet_age',suffix:' æ­²'}, {label:'æ€§åˆ¥',key:'pet_sex'}, {label:'çµç´®',key:'is_neutered'}, {label:'æ™¶ç‰‡',key:'pet_chip',full:true}] },
            { title: 'âš ï¸ è¡Œç‚ºèˆ‡å¥åº·', fields: [{label:'è¦ªäºº',key:'is_friendly'}, {label:'è¦ªç‹—',key:'is_dog_friendly'}, {label:'æ”»æ“Šæ€§',key:'is_aggressive',highlight:'æ˜¯'}, {label:'ç—…å²',key:'has_history',highlight:'æœ‰'}, {label:'ç—…å²è©³æƒ…',key:'history_notes',full:true}, {label:'é¢¨éšªå› å­',key:'risk_factors',full:true,isTag:true}] },
            { title: 'âœ‚ï¸ æœå‹™å…§å®¹', fields: [{label:'é …ç›®',key:'service_type',full:true,highlight:true}, {label:'æ¥å›æ™‚é–“',key:'pickup_time'}] }
        ];

        let html = '';

        // å‚™è¨»å€å¡Š
        const notes = currentItem.notes || '';
        const noteDisplayClass = notes ? 'whitespace-pre-wrap text-theme-text' : 'text-gray-400 italic';
        const noteDisplayText = notes ? notes : 'é»æ“Šä¸‹æ–¹ã€Œç·¨è¼¯ã€æŒ‰éˆ•å³å¯æ–°å¢å‚™è¨»...';

        html += `
            <div class="glass-panel rounded-2xl p-5 border-l-4 border-l-purple-400 mb-6 shadow-sm">
                <h3 class="font-bold text-theme-text text-sm mb-2 flex items-center gap-2">
                    <i data-lucide="notebook-pen" class="w-4 h-4 text-purple-500"></i> ç®¡ç†å“¡å‚™è¨»
                </h3>
                <div class="view-mode text-sm min-h-[20px] leading-relaxed ${noteDisplayClass}">${noteDisplayText}</div>
                <textarea data-key="notes" class="edit-mode hidden input-minimal w-full h-24 text-sm resize-none focus:ring-2 focus:ring-purple-200" placeholder="è«‹è¼¸å…¥å‚™è¨»äº‹é …...">${notes}</textarea>
            </div>
        `;
        
        // è³‡æ–™å€å¡Š
        sections.forEach(section => {
            html += `<div class="glass-panel rounded-2xl overflow-hidden mb-4 border border-white/60"><div class="bg-theme-rose/5 px-5 py-3 border-b border-theme-rose/10"><h3 class="font-bold text-theme-text text-sm">${section.title}</h3></div><div class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-4">`;
            section.fields.forEach(f => {
                let val = currentItem[f.key];
                if (val === null || val === undefined) val = '-';
                if(f.suffix && val !== '-') val += f.suffix;
                
                let displayVal = val;
                if (f.isTag && val !== '-' && typeof val === 'string') {
                    displayVal = val.split(',').map(v => `<span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-500 text-xs font-bold mr-1">${v}</span>`).join('');
                } else if (f.highlight === true || val === f.highlight) {
                    displayVal = `<span class="text-theme-rose font-bold">${val}</span>`;
                }

                html += `
                    <div class="${f.full ? 'sm:col-span-2' : ''}">
                        <label class="block text-[10px] font-bold text-theme-sub mb-1 uppercase tracking-wider">${f.label}</label>
                        <div class="view-mode text-sm font-bold text-theme-text min-h-[24px] flex items-center">${displayVal}</div>
                        <input type="text" data-key="${f.key}" value="${currentItem[f.key] || ''}" class="edit-mode hidden input-minimal py-1.5 px-3 text-sm h-9">
                    </div>`;
            });
            html += `</div></div>`;
        });

        // ç°½å
        if (currentItem.signature_data) {
            html += `<div class="glass-panel rounded-2xl p-5 border border-white/60 mt-4"><h3 class="font-bold text-theme-text text-sm mb-3">âœï¸ é›»å­ç°½å</h3><div class="bg-white/50 rounded-xl p-4 border border-dashed border-theme-sub/20 flex justify-center"><img src="${currentItem.signature_data}" class="max-h-24 object-contain"></div></div>`;
        }

        content.innerHTML = html;
        
        // ğŸŒŸ æ¬Šé™æ§åˆ¶æ ¸å¿ƒ ğŸŒŸ
        const deleteBtn = document.querySelector('button[onclick="requestDelete()"]');
        const editBtn = document.getElementById('btn-edit');
        
        if (currentRole === 'staff') {
            // å“¡å·¥ï¼šéš±è—åˆªé™¤æŒ‰éˆ•
            deleteBtn.classList.add('hidden');
            // å“¡å·¥ï¼šæŒ‰éˆ•æ”¹å
            editBtn.innerHTML = '<i data-lucide="notebook-pen" class="w-4 h-4"></i> ä¿®æ”¹å‚™è¨»';
        } else {
            deleteBtn.classList.remove('hidden');
            editBtn.innerText = "ç·¨è¼¯è³‡æ–™";
        }

        // é¡¯ç¤º
        document.getElementById('btn-edit').classList.remove('hidden');
        document.getElementById('btn-save').classList.add('hidden');
        
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            panel.classList.remove('translate-y-full');
        }, 10);
        lucide.createIcons();
    }

    function closeModal() {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.add('opacity-0');
        panel.classList.add('translate-y-full');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // å•Ÿç”¨ç·¨è¼¯æ¨¡å¼ (å“¡å·¥é™åˆ¶)
    function enableEdit() {
        document.getElementById('btn-edit').classList.add('hidden');
        document.getElementById('btn-save').classList.remove('hidden');
        
        if (currentRole === 'staff') {
            // å“¡å·¥ï¼šåªé¡¯ç¤ºã€Œå‚™è¨»ã€çš„ç·¨è¼¯æ¡†
            const notesInput = document.querySelector('.edit-mode[data-key="notes"]');
            const notesView = notesInput.previousElementSibling;
            
            notesView.classList.add('hidden');
            notesInput.classList.remove('hidden');
            notesInput.focus();
            
            showToast('å“¡å·¥æ¬Šé™ï¼šåƒ…é–‹æ”¾ä¿®æ”¹å‚™è¨»', 'info');
        } else {
            // ç®¡ç†å“¡ï¼šå…¨éƒ¨æ¬„ä½å¯ç·¨è¼¯
            document.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
            showToast('å·²é€²å…¥ç·¨è¼¯æ¨¡å¼', 'success');
        }
    }

    // é»æ“Šã€Œå„²å­˜è®Šæ›´ã€ (é‚è¼¯åˆ¤æ–·)
    function saveChanges() {
        let sensitiveChanged = false;
        let notesChanged = false;
        let hasChanges = false;

        document.querySelectorAll('.edit-mode').forEach(input => {
            const key = input.dataset.key;
            if (!key) return;
            
            let originalValue = currentItem[key];
            if (originalValue === null || originalValue === undefined) originalValue = '';
            
            let newValue = input.value;
            
            if (String(originalValue).trim() !== String(newValue).trim()) {
                hasChanges = true;
                if (key === 'notes') {
                    notesChanged = true;
                } else {
                    sensitiveChanged = true;
                }
            }
        });

        if (!hasChanges) {
            showToast('æœªåµæ¸¬åˆ°ä»»ä½•è®Šæ›´', 'info');
            openModal(currentItem.id);
            return;
        }

        if (sensitiveChanged) {
            // æ”¹äº†æ•æ„Ÿè³‡æ–™ -> éœ€è¦é©—è­‰å¯†ç¢¼
            showAuthModal('save');
        } else {
            // åªæ”¹å‚™è¨» -> ç›´æ¥å­˜
            executeSave();
        }
    }

    // é»æ“Šã€Œåˆªé™¤ã€æŒ‰éˆ•
    function requestDelete() {
        showAuthModal('delete');
    }

    // çœŸæ­£çš„å„²å­˜åŸ·è¡Œå‡½å¼ (åŒ…å«æ¬Šé™éæ¿¾)
    async function executeSave() {
        const btn = document.getElementById('btn-save');
        if (!btn) return;
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> å„²å­˜ä¸­...';
            btn.disabled = true;
            lucide.createIcons();

            const updates = {};
            document.querySelectorAll('.edit-mode').forEach(input => {
                const key = input.dataset.key;
                // ğŸ”’ å“¡å·¥é–ï¼šå¦‚æœæ˜¯å“¡å·¥ï¼ŒåªæŠ“å– notes æ¬„ä½ï¼Œå¿½ç•¥å…¶ä»–
                if (currentRole === 'staff' && key !== 'notes') return;
                if (key) updates[key] = input.value;
            });

            const { error } = await _supabase
                .from('service_contracts')
                .update(updates)
                .eq('id', currentItem.id);

            if (error) throw error;

            showToast('è³‡æ–™å·²æ›´æ–°', 'success');
            closeModal();
            loadData();

        } catch (error) {
            console.error('Save Error:', error);
            showToast('å„²å­˜å¤±æ•—: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // åŸ·è¡Œåˆªé™¤
    async function executeDelete() {
        const { error } = await _supabase
            .from('service_contracts')
            .delete()
            .eq('id', currentItem.id);

        if (error) {
            showToast('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
        } else {
            showToast('å·²åˆªé™¤è©²ç­†è³‡æ–™', 'success');
            closeModal();
            loadData();
        }
    }

    // --- 4. å®‰å…¨é©—è­‰èˆ‡å¯†ç¢¼ä¿®æ”¹ ---

    // é–‹å•Ÿé©—è­‰å½ˆçª—
    function showAuthModal(actionType) {
        pendingAction = actionType;
        const titleEl = document.getElementById('auth-title');
        const descEl = document.getElementById('auth-desc');
        
        if (actionType === 'save') {
            titleEl.innerText = 'å®‰å…¨é©—è­‰';
            descEl.innerText = 'ä¿®æ”¹æ•æ„Ÿè³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        } else if (actionType === 'delete') {
            titleEl.innerText = 'åˆªé™¤ç¢ºèª';
            descEl.innerText = 'åˆªé™¤æ­¤ç­†è³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        }

        document.getElementById('auth-password').value = '';
        const modal = document.getElementById('auth-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        setTimeout(() => document.getElementById('auth-password').focus(), 100);
    }

    function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // è™•ç†é©—è­‰ç¢ºèª
    async function handleAuthConfirm() {
        const btn = document.getElementById('auth-confirm-btn');
        const originalText = btn.innerHTML;
        const password = document.getElementById('auth-password').value;
        
        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // é©—è­‰å¯†ç¢¼ (ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿé©—è­‰)
            const { error } = await _supabase.auth.signInWithPassword({
                email: ACCOUNTS.admin,
                password: password
            });

            if (error) throw error;

            const action = pendingAction;
            closeAuthModal();
            
            setTimeout(() => {
                if (action === 'save') executeSave();
                else if (action === 'delete') executeDelete();
            }, 300);

        } catch (error) {
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // åˆ‡æ›ä¿®æ”¹å¯†ç¢¼å°è±¡ (UI)
    function switchCpTarget(target) {
        cpTargetRole = target;
        const btnAdmin = document.getElementById('cp-target-admin');
        const btnStaff = document.getElementById('cp-target-staff');
        const input = document.getElementById('cp-old-password');

        if (target === 'admin') {
            btnAdmin.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-theme-text shadow-sm";
            btnStaff.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all text-theme-sub hover:bg-white/50";
            input.placeholder = "è«‹è¼¸å…¥ç®¡ç†å“¡èˆŠå¯†ç¢¼";
        } else {
            btnStaff.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white text-theme-text shadow-sm";
            btnAdmin.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all text-theme-sub hover:bg-white/50";
            input.placeholder = "è«‹è¼¸å…¥å“¡å·¥èˆŠå¯†ç¢¼";
        }
    }

    function openChangePasswordModal() {
        const modal = document.getElementById('change-pwd-modal');
        const selector = document.getElementById('cp-role-selector');
        
        // åªæœ‰ç®¡ç†å“¡èƒ½çœ‹åˆ°é¸æ“‡å™¨
        if (currentRole === 'admin') {
            selector.classList.remove('hidden');
            switchCpTarget('admin'); // é è¨­é¸è‡ªå·±
        } else {
            selector.classList.add('hidden');
            cpTargetRole = 'staff'; // å“¡å·¥åªèƒ½æ”¹å“¡å·¥
        }

        document.getElementById('cp-old-password').value = '';
        document.getElementById('cp-new-password').value = '';
        document.getElementById('cp-confirm-password').value = '';
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        lucide.createIcons();
    }

    function closeChangePasswordModal() {
        const modal = document.getElementById('change-pwd-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function handleChangePassword() {
        const oldPwd = document.getElementById('cp-old-password').value;
        const newPwd = document.getElementById('cp-new-password').value;
        const confirmPwd = document.getElementById('cp-confirm-password').value;
        const btn = document.getElementById('btn-change-pwd');
        const originalText = btn.innerHTML;

        if (!oldPwd || !newPwd || !confirmPwd) {
            showToast('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
            return;
        }
        if (newPwd.length < 6) {
            showToast('æ–°å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ä½', 'error');
            return;
        }
        if (newPwd !== confirmPwd) {
            showToast('å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> è™•ç†ä¸­';
            btn.disabled = true;
            lucide.createIcons();

            // é©—è­‰èˆŠå¯†ç¢¼ (å¿…é ˆä½¿ç”¨ç›®æ¨™å¸³è™Ÿç™»å…¥ä¾†é©—è­‰)
            const targetEmail = ACCOUNTS[cpTargetRole];
            const { error: signInError } = await _supabase.auth.signInWithPassword({
                email: targetEmail,
                password: oldPwd
            });

            if (signInError) {
                showToast('èˆŠå¯†ç¢¼éŒ¯èª¤', 'error');
                return;
            }

            // æ›´æ–°å¯†ç¢¼
            const { error: updateError } = await _supabase.auth.updateUser({ password: newPwd });
            if (updateError) throw updateError;

            // å¼·åˆ¶ç™»å‡ºé‡ä¾†
            await _supabase.auth.signOut();
            localStorage.setItem('pwd_changed', 'true');
            location.reload();

        } catch (error) {
            showToast('ä¿®æ”¹å¤±æ•—', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // Toast æç¤º
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        const bgClass = type === 'success' ? 'bg-[#06C755]' : 'bg-red-500';
        const icon = type === 'success' ? 'check-circle' : 'alert-circle';
        
        el.className = `${bgClass} text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 transform translate-y-[-20px] opacity-0 transition-all duration-300 font-bold tracking-wide`;
        el.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i> ${message}`;
        
        container.appendChild(el);
        lucide.createIcons();

        requestAnimationFrame(() => {
            el.classList.remove('translate-y-[-20px]', 'opacity-0');
        });

        setTimeout(() => {
            el.classList.add('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    }

    // ç¶å®šäº‹ä»¶ï¼šå¼·åˆ¶ä¿®æ­£å„²å­˜æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
        const saveBtn = document.getElementById('btn-save');
        if (saveBtn) {
            saveBtn.removeAttribute('onclick');
            saveBtn.onclick = saveChanges;
        }
    });

    // é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆçª—
    document.getElementById('detail-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('detail-modal')) closeModal();
    });
</script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw-admin.js?v=1');
                    console.log('Admin SW è¨»å†ŠæˆåŠŸ');
                } catch (error) {
                    console.error('Admin SW è¨»å†Šå¤±æ•—:', error);
                }
            });
        }
    </script>
</body>
</html>

