<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>èŒå¯µç•¶å®¶ | å¾Œå°ç®¡ç†ç³»çµ±</title>
    
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">

    <!-- PWA Admin è¨­å®š -->
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#D88E99">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw-admin.js');
            });
        }
    </script>

    <!-- å¼•å…¥èˆ‡é¦–é ç›¸åŒçš„å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@300;400;500;700;900&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = { 
            theme: {
                extend: {
                    colors: {
                        theme: {
                            bg: '#FAF8F5',
                            rose: '#D88E99',
                            roseDeep: '#B56576',
                            gold: '#C5A065',
                            goldLight: '#E5CFA0',
                            text: '#4A4238',
                            sub: '#8C857B',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        en: ['"Cormorant Garamond"', 'serif'],
                    },
                    backgroundImage: {
                        'gradient-lux': 'linear-gradient(135deg, #D88E99 0%, #C5A065 100%)',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            background-color: #FAF8F5;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(216, 142, 153, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(197, 160, 101, 0.08) 0%, transparent 40%);
            font-family: 'Noto Serif TC', serif; 
            color: #4A4238;
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass-panel { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px 0 rgba(74, 66, 56, 0.08);
        }

        .input-minimal {
            width: 100%;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(140, 133, 123, 0.2);
            padding: 0.8rem 1rem;
            border-radius: 12px;
            color: #4A4238;
            transition: all 0.3s;
        }
        .input-minimal:focus {
            background: #FFFFFF;
            border-color: #D88E99;
            outline: none;
            box-shadow: 0 4px 12px rgba(216, 142, 153, 0.15);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* å‹•ç•« */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: .6; }
        }
        .skeleton-card { animation: pulse-slow 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="fixed top-5 left-0 right-0 z-[100] flex flex-col items-center space-y-2 pointer-events-none px-4"></div>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
        <!-- èƒŒæ™¯è£é£¾ -->
        <div class="absolute -top-24 -right-24 w-96 h-96 bg-theme-rose/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-24 -left-24 w-96 h-96 bg-theme-gold/10 rounded-full blur-3xl"></div>

        <div class="glass-panel p-10 rounded-[32px] w-full max-w-sm text-center space-y-8 relative z-10">
            <div class="mx-auto w-24 h-24 rounded-full bg-white p-2 shadow-xl border border-white/50 -mt-20 mb-6 flex items-center justify-center">
                <img src="logo.png" alt="Logo" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <i data-lucide="dog" class="hidden w-10 h-10 text-theme-rose"></i>
            </div>

            <div class="space-y-2">
                <h1 class="text-3xl font-black text-theme-text tracking-widest">èŒå¯µç•¶å®¶</h1>
                <p class="text-xs text-theme-sub font-bold tracking-[0.2em] uppercase">Admin Dashboard</p>
            </div>

<div class="relative group">
    <i data-lucide="lock" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50 group-focus-within:text-theme-rose transition-colors"></i>
    <input type="password" id="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" 
           class="input-minimal pl-12 text-center tracking-widest"
           onkeydown="if(event.key==='Enter') document.getElementById('login-btn').click()">
</div>

<button id="login-btn" onclick="handleLogin(event)" class="w-full py-4 bg-gradient-lux text-white font-bold rounded-xl shadow-lg shadow-theme-rose/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-base hover:-translate-y-1">
    ç™»å…¥ç³»çµ± <i data-lucide="arrow-right" class="w-5 h-5"></i>
</button>
            
            <div class="pt-4 border-t border-theme-sub/10">
                <a href="index.html" class="text-xs text-theme-sub hover:text-theme-rose transition-colors inline-flex items-center gap-1">
                    <i data-lucide="arrow-left" class="w-3 h-3"></i> è¿”å›é¦–é 
                </a>
            </div>
        </div>
    </div>

    <!-- ä¸»æ§å°ç•«é¢ -->
    <div id="dashboard-view" class="hidden min-h-screen pb-24">
        
        <!-- é ‚éƒ¨å°èˆªåˆ— -->
        <nav class="bg-white/60 backdrop-blur-xl border-b border-white/40 sticky top-0 z-40">
            <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-theme-rose/10 flex items-center justify-center text-theme-rose border border-theme-rose/20">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-lg text-theme-text tracking-widest hidden sm:inline">å¾Œå°ç®¡ç†</span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="openChangePasswordModal()" class="text-xs font-bold text-theme-text hover:text-theme-rose px-3 py-2 rounded-lg hover:bg-theme-rose/5 transition flex items-center gap-1.5" title="è®Šæ›´å¯†ç¢¼">
                        <i data-lucide="key-round" class="w-4 h-4"></i> <span class="hidden sm:inline">è®Šæ›´å¯†ç¢¼</span>
                    </button>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <button onclick="handleLogout()" class="text-xs font-bold text-theme-sub hover:text-theme-rose px-3 py-2 rounded-lg hover:bg-theme-rose/5 transition flex items-center gap-1.5">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡º
                    </button>
                </div>
                    </nav>

        <div class="max-w-4xl mx-auto p-6 space-y-6">
            
            <!-- æ¨™é¡Œèˆ‡æœå°‹ -->
            <div class="flex flex-col md:flex-row gap-4 justify-between items-end md:items-center">
                <div>
                    <h2 class="text-2xl font-black text-theme-text tracking-wider">ç¾å®¹å¥‘ç´„åˆ—è¡¨</h2>
                    <p class="text-xs text-theme-sub mt-1 tracking-wide">Service Contracts</p>
                </div>
                <div class="relative w-full md:w-64 group">
                    <i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50 group-focus-within:text-theme-rose transition-colors"></i>
                    <input type="search" id="search-input" placeholder="æœå°‹å¯µç‰©åã€ä¸»äººå§“åã€é›»è©±..." 
                           class="input-minimal pl-10 py-2.5 text-sm bg-white/80">
                </div>
            </div>

            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="content-area" class="space-y-3">
                <div class="text-center py-10 text-theme-sub/50">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è©³æƒ…/ç·¨è¼¯å½ˆçª— -->
    <div id="detail-modal" class="fixed inset-0 bg-theme-text/20 hidden z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-[#FAF8F5] w-full max-w-3xl rounded-t-[32px] sm:rounded-[32px] flex flex-col shadow-2xl transform transition-transform duration-300 max-h-[90vh] border border-white/50" id="modal-panel">
            
            <!-- å½ˆçª—æ¨™é¡Œ -->
            <div class="p-6 border-b border-theme-sub/10 flex justify-between items-center bg-white/50 rounded-t-[32px] shrink-0">
                <div>
                    <h2 class="text-xl font-black text-theme-text tracking-wider">åˆç´„è©³æƒ…</h2>
                    <span class="text-[10px] text-theme-sub uppercase tracking-widest font-bold" id="modal-id">ID: #0000</span>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-theme-sub hover:text-theme-rose hover:shadow-md transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- å½ˆçª—å…§å®¹ -->
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-6 bg-[#FAF8F5]" id="modal-content">
                <!-- JS å‹•æ…‹å¡«å…¥ -->
            </div>
            
            <!-- å½ˆçª—åº•éƒ¨æŒ‰éˆ• -->
            <div class="p-5 border-t border-theme-sub/10 bg-white/80 backdrop-blur rounded-b-none sm:rounded-b-[32px] flex justify-between items-center gap-3 shrink-0">
                <button onclick="requestDelete()" class="text-red-400 font-bold px-4 py-3 hover:bg-red-50 rounded-xl transition active:scale-95 flex items-center gap-2 text-sm">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤
                </button>
                <div class="flex gap-3 flex-1 justify-end">
                    <button onclick="enableEdit()" id="btn-edit" class="bg-white border border-theme-sub/20 text-theme-text px-6 py-3 rounded-xl font-bold hover:border-theme-rose hover:text-theme-rose transition active:scale-95 shadow-sm">
                        ç·¨è¼¯è³‡æ–™
                    </button>
                    <button onclick="saveChanges()" id="btn-save" class="hidden bg-theme-text text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition active:scale-95 shadow-lg flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- è®Šæ›´å¯†ç¢¼å½ˆçª— -->
    <div id="change-pwd-modal" class="fixed inset-0 bg-theme-text/40 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-[24px] w-full max-w-[400px] shadow-2xl transform scale-95 transition-transform duration-300 relative">
            
            <!-- é—œé–‰æŒ‰éˆ• -->
            <button onclick="closeChangePasswordModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <h3 class="text-xl font-bold text-theme-text mb-8 tracking-wider font-serif">è®Šæ›´ç®¡ç†å¯†ç¢¼</h3>

            <div class="space-y-4">
                <!-- èˆŠå¯†ç¢¼ -->
                <div class="relative group">
                    <i data-lucide="lock" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                    <input type="password" id="cp-old-password" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" 
                           class="w-full bg-[#FAF8F5] border border-transparent focus:bg-white focus:border-theme-rose/30 rounded-xl py-3 pl-11 pr-4 text-sm text-theme-text outline-none transition-all placeholder:text-gray-400">
                </div>

                <!-- æ–°å¯†ç¢¼ -->
                <div class="relative group">
                    <i data-lucide="key" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                    <input type="password" id="cp-new-password" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘6ä½)" 
                           class="w-full bg-[#FAF8F5] border border-transparent focus:bg-white focus:border-theme-rose/30 rounded-xl py-3 pl-11 pr-4 text-sm text-theme-text outline-none transition-all placeholder:text-gray-400">
                </div>

                <!-- ç¢ºèªæ–°å¯†ç¢¼ -->
                <div class="relative group">
                    <i data-lucide="shield-check" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                    <input type="password" id="cp-confirm-password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" 
                           class="w-full bg-[#FAF8F5] border border-transparent focus:bg-white focus:border-theme-rose/30 rounded-xl py-3 pl-11 pr-4 text-sm text-theme-text outline-none transition-all placeholder:text-gray-400">
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeChangePasswordModal()" class="flex-1 py-3 bg-[#F3F4F6] text-theme-text font-bold rounded-xl hover:bg-gray-200 transition text-sm">
                    å–æ¶ˆ
                </button>
                <button onclick="handleChangePassword()" id="btn-change-pwd" class="flex-1 py-3 bg-[#5D5447] text-white font-bold rounded-xl shadow-lg hover:bg-[#4A4238] active:scale-95 transition text-sm flex items-center justify-center gap-2">
                    ç¢ºèªä¿®æ”¹
                </button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨å¯†ç¢¼é©—è­‰å½ˆçª— -->
    <div id="auth-modal" class="fixed inset-0 bg-theme-text/40 hidden z-[70] flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-[32px] w-full max-w-xs text-center space-y-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="mx-auto w-16 h-16 rounded-full bg-theme-text/5 flex items-center justify-center text-theme-text mb-2">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            
            <div class="space-y-2">
                <h3 class="text-xl font-black text-theme-text" id="auth-title">å®‰å…¨é©—è­‰</h3>
                <p class="text-sm text-theme-sub font-medium" id="auth-desc">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
            </div>

            <div class="relative group text-left">
                <i data-lucide="key" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                <input type="password" id="auth-password" placeholder="è¼¸å…¥å¯†ç¢¼" 
                       class="input-minimal pl-10 text-center tracking-widest bg-gray-50 border-gray-200"
                       onkeydown="if(event.key==='Enter') handleAuthConfirm()">
            </div>

            <div class="flex gap-3">
                <button onclick="closeAuthModal()" class="flex-1 py-3 bg-gray-100 text-theme-sub font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button onclick="handleAuthConfirm()" id="auth-confirm-btn" class="flex-1 py-3 bg-theme-text text-white font-bold rounded-xl shadow-lg shadow-theme-text/20 active:scale-95 transition">
                    ç¢ºèª
                </button>
            </div>
        </div>
    </div>

<script>
    // åˆå§‹åŒ–
    lucide.createIcons();

    // --- æª¢æŸ¥æ˜¯å¦å‰›ä¿®æ”¹å®Œå¯†ç¢¼ ---
    if (localStorage.getItem('pwd_changed')) {
        // å»¶é²ä¸€é»é»é¡¯ç¤ºï¼Œç¢ºä¿ç•«é¢è¼‰å…¥å®Œæˆ
        setTimeout(() => {
            showToast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼Œè«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥', 'success');
        }, 500);
        localStorage.removeItem('pwd_changed'); // æ¸…é™¤æ¨™è¨˜
    }
    
    // --- Supabase è¨­å®š ---

    const SUPABASE_URL = 'https://anzxwdphcxafxsglomez.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFuenh3ZHBoY3hhZnhzZ2xvbWV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MjU2MzUsImV4cCI6MjA4NDMwMTYzNX0.i6ZHUO7UGz8AbAUz7fPHavYxKG1O-UE4k7Xr2VqP9xc';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // å…¨åŸŸè®Šæ•¸
    let fullDataList = [];
    let currentItem = null;
    let pendingAction = null; // å„²å­˜å¾…åŸ·è¡Œçš„å‹•ä½œ ('save' æˆ– 'delete')

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    async function checkSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) { 
            showDashboard();
        }
    }
    checkSession();

    // é¡¯ç¤ºä¸»æ§å°
    function showDashboard() {
        document.getElementById('login-view').classList.add('hidden'); 
        document.getElementById('dashboard-view').classList.remove('hidden'); 
        loadData(); 
    }

    // ç™»å…¥è™•ç†
    async function handleLogin(event) {
        const btn = document.getElementById('login-btn');
        const originalBtnHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i>';
        lucide.createIcons();

        const email = 'elvira5201314@gmail.com'; 
        const password = document.getElementById('password').value;

        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
            return;
        }

        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
            document.getElementById('password').value = '';
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        } else {
            showToast('ç™»å…¥æˆåŠŸï¼', 'success');
            showDashboard();
        }
    }

    // ç™»å‡º
    async function handleLogout() {
        await _supabase.auth.signOut();
        location.reload();
    }
    // --- è®Šæ›´å¯†ç¢¼åŠŸèƒ½ ---
    
    function openChangePasswordModal() {
        const modal = document.getElementById('change-pwd-modal');
        // æ¸…ç©ºæ¬„ä½
        document.getElementById('cp-old-password').value = '';
        document.getElementById('cp-new-password').value = '';
        document.getElementById('cp-confirm-password').value = '';
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        lucide.createIcons();
    }

    function closeChangePasswordModal() {
        const modal = document.getElementById('change-pwd-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function handleChangePassword() {
        const oldPwd = document.getElementById('cp-old-password').value;
        const newPwd = document.getElementById('cp-new-password').value;
        const confirmPwd = document.getElementById('cp-confirm-password').value;
        const btn = document.getElementById('btn-change-pwd');
        const originalText = btn.innerHTML;

        // 1. åŸºæœ¬é©—è­‰
        if (!oldPwd || !newPwd || !confirmPwd) {
            showToast('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
            return;
        }
        if (newPwd.length < 6) {
            showToast('æ–°å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ä½', 'error');
            return;
        }
        if (newPwd !== confirmPwd) {
            showToast('å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> è™•ç†ä¸­';
            btn.disabled = true;
            lucide.createIcons();

            // 2. é©—è­‰èˆŠå¯†ç¢¼æ˜¯å¦æ­£ç¢º (é‡æ–°ç™»å…¥ä¸€æ¬¡ä¾†é©—è­‰)
            // é€™è£¡å‡è¨­ä½ çš„ç®¡ç†å“¡ email æ˜¯å›ºå®šçš„
            const email = 'elvira5201314@gmail.com'; 
            
            const { error: signInError } = await _supabase.auth.signInWithPassword({
                email: email,
                password: oldPwd
            });

            if (signInError) {
                throw new Error('èˆŠå¯†ç¢¼éŒ¯èª¤');
            }

            // 3. æ›´æ–°å¯†ç¢¼
            const { error: updateError } = await _supabase.auth.updateUser({ 
                password: newPwd 
            });

            if (updateError) throw updateError;

            // --- ä¿®æ”¹æˆåŠŸå¾Œçš„å‹•ä½œ ---
            await _supabase.auth.signOut(); // å¼·åˆ¶ç™»å‡º
            localStorage.setItem('pwd_changed', 'true'); // è¨­å®šæ¨™è¨˜
            location.reload(); // é‡æ–°æ•´ç†é é¢

        } catch (error) {

            console.error(error);
            showToast(error.message || 'ä¿®æ”¹å¤±æ•—', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
        const container = document.getElementById('content-area');
        
        // éª¨æ¶å±
        container.innerHTML = Array(5).fill(0).map(() => `
            <div class="glass-panel p-4 rounded-2xl flex justify-between items-center skeleton-card">
                <div class="space-y-2 w-1/2">
                    <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                    <div class="h-6 bg-gray-200 rounded w-2/3"></div>
                </div>
                <div class="h-8 w-20 bg-gray-200 rounded-lg"></div>
            </div>
        `).join('');

        const { data, error } = await _supabase
            .from('service_contracts')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<div class="text-center text-red-400 py-10">è®€å–éŒ¯èª¤: ${error.message}</div>`;
            return;
        }

        fullDataList = data;
        renderDataList(data);
    }

    // æ¸²æŸ“åˆ—è¡¨ (ä¿®æ­£ç‰ˆï¼šç§»é™¤ã€Œç„¡æ¨™ç±¤ã€æ–‡å­—ï¼Œè‹¥ç„¡æ¨™ç±¤å‰‡ä¸ä½”ä½)
    function renderDataList(data) {
        const container = document.getElementById('content-area');
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-20 h-20 bg-theme-sub/5 rounded-full flex items-center justify-center mx-auto mb-4">
                         <i data-lucide="file-x" class="w-10 h-10 text-theme-sub/30"></i>
                    </div>
                    <p class="text-theme-sub font-bold">æš«ç„¡è³‡æ–™</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        container.innerHTML = data.map((item, index) => {
            const date = new Date(item.created_at).toLocaleString('zh-TW', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            // åˆ¤æ–·æ˜¯å¦æœ‰é¢¨éšªæ¨™ç±¤
            const hasRisk = item.risk_factors && item.risk_factors.length > 0;
            const riskTag = hasRisk ? 
                `<span class="px-2 py-0.5 rounded-md bg-red-100 text-red-500 text-[10px] font-bold whitespace-nowrap">é«˜é¢¨éšª</span>` : '';

            // åˆ¤æ–·æ˜¯å¦æœ‰å‚™è¨»æ¨™ç±¤
            const hasNotes = item.notes && item.notes.trim().length > 0;
            const noteTag = hasNotes ? 
                `<span class="px-2 py-0.5 rounded-md bg-purple-100 text-purple-600 text-[10px] font-bold flex items-center gap-1 whitespace-nowrap"><i data-lucide="sticky-note" class="w-3 h-3"></i> å‚™è¨»</span>` : '';

            // â˜… ä¿®æ”¹é‡é»ï¼šåªæœ‰åœ¨ã€Œæœ‰é¢¨éšªã€æˆ–ã€Œæœ‰å‚™è¨»ã€æ™‚ï¼Œæ‰é¡¯ç¤ºé€™ä¸€æ•´è¡Œ divï¼Œå¦å‰‡è¼¸å‡ºç©ºå­—ä¸² ''
            const tagsHtml = (riskTag || noteTag) ? 
                `<div class="flex items-center gap-2 flex-wrap mt-1">${riskTag}${noteTag}</div>` : '';

            return `
            <div onclick="openModal('${item.id}')" class="glass-panel p-5 rounded-2xl flex justify-between items-center cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all group border-l-4 border-l-transparent hover:border-l-theme-rose">
                <div class="flex items-center gap-4 w-full overflow-hidden">
                    <div class="w-12 h-12 rounded-full bg-theme-gold/10 text-theme-gold flex items-center justify-center font-bold text-lg shrink-0">
                        ${item.pet_name ? item.pet_name[0] : '?'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <!-- ç¬¬ä¸€è¡Œï¼šåå­— + ä¸»äºº -->
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-theme-text text-lg truncate">${item.pet_name}</h3>
                            <span class="text-xs text-theme-sub truncate">(${item.owner_name})</span>
                        </div>
                        
                        <!-- ç¬¬äºŒè¡Œï¼šæ¨™ç±¤å€ (å®Œå…¨å‹•æ…‹ï¼Œç„¡å…§å®¹å‰‡ä¸é¡¯ç¤º) -->
                        ${tagsHtml}
                        
                        <!-- ç¬¬ä¸‰è¡Œï¼šè³‡è¨Š -->
                        <div class="flex items-center gap-3 mt-2 text-xs text-theme-sub font-medium truncate">
                            <span class="flex items-center gap-1"><i data-lucide="scissors" class="w-3 h-3"></i> ${item.service_type || 'æœªæŒ‡å®š'}</span>
                            <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${date}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right hidden sm:block pl-4 shrink-0">
                    <span class="text-xs font-bold text-theme-rose border border-theme-rose/30 px-3 py-1 rounded-full group-hover:bg-theme-rose group-hover:text-white transition-colors">
                        æŸ¥çœ‹
                    </span>
                </div>
            </div>`;
        }).join('');
        lucide.createIcons();
    }


    // æœå°‹åŠŸèƒ½
    document.getElementById('search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = fullDataList.filter(item => 
            (item.owner_name && item.owner_name.includes(term)) ||
            (item.owner_phone && item.owner_phone.includes(term)) ||
            (item.pet_name && item.pet_name.includes(term))
        );
        renderDataList(filtered);
    });

    // é–‹å•Ÿè©³æƒ…å½ˆçª— (ä¿®æ­£ç‰ˆï¼šè§£æ±ºå‚™è¨»æ–‡å­—è·‘ç‰ˆå•é¡Œ)
    function openModal(id) {
        currentItem = fullDataList.find(i => i.id == id);
        
        if (!currentItem) {
            alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²ç­†è³‡æ–™");
            return;
        }

        const idStr = String(currentItem.id);
        document.getElementById('modal-id').innerText = `ID: #${idStr.length > 8 ? idStr.substring(0, 8) : idStr}`;
        
        const content = document.getElementById('modal-content');
        
        const sections = [
            {
                title: 'ğŸ‘¤ é£¼ä¸»è³‡æ–™',
                fields: [
                    { label: 'å§“å', key: 'owner_name' },
                    { label: 'é›»è©±', key: 'owner_phone' },
                    { label: 'Email', key: 'owner_email' },
                    { label: 'èº«åˆ†è­‰', key: 'owner_id' },
                    { label: 'åœ°å€', key: 'owner_address', full: true }
                ]
            },
            {
                title: 'ğŸš‘ ç·Šæ€¥è¯çµ¡',
                fields: [
                    { label: 'è¯çµ¡äºº', key: 'emergency_name' },
                    { label: 'ç·Šæ€¥é›»è©±', key: 'emergency_phone' },
                    { label: 'æŒ‡å®šé†«é™¢', key: 'hospital', full: true }
                ]
            },
            {
                title: 'ğŸ¾ å¯µç‰©è³‡æ–™',
                fields: [
                    { label: 'åå­—', key: 'pet_name' },
                    { label: 'å“ç¨®', key: 'pet_breed' },
                    { label: 'èŠ±è‰²', key: 'pet_color' },
                    { label: 'å¹´é½¡', key: 'pet_age', suffix: ' æ­²' },
                    { label: 'æ€§åˆ¥', key: 'pet_sex' },
                    { label: 'çµç´®', key: 'is_neutered' },
                    { label: 'æ™¶ç‰‡', key: 'pet_chip', full: true }
                ]
            },
            {
                title: 'âš ï¸ è¡Œç‚ºèˆ‡å¥åº·',
                fields: [
                    { label: 'è¦ªäºº', key: 'is_friendly' },
                    { label: 'è¦ªç‹—', key: 'is_dog_friendly' },
                    { label: 'æ”»æ“Šæ€§', key: 'is_aggressive', highlight: 'æ˜¯' },
                    { label: 'ç—…å²', key: 'has_history', highlight: 'æœ‰' },
                    { label: 'ç—…å²è©³æƒ…', key: 'history_notes', full: true },
                    { label: 'é¢¨éšªå› å­', key: 'risk_factors', full: true, isTag: true }
                ]
            },
            {
                title: 'âœ‚ï¸ æœå‹™å…§å®¹',
                fields: [
                    { label: 'é …ç›®', key: 'service_type', full: true, highlight: true },
                    { label: 'æ¥å›æ™‚é–“', key: 'pickup_time' }
                ]
            }
        ];

        let html = '';

        // --- å‚™è¨»å€å¡Š (ä¿®æ­£ç‰ˆ) ---
        const notes = currentItem.notes || '';
        // åˆ¤æ–·ï¼šå¦‚æœæœ‰å…§å®¹æ‰ç”¨ pre-wrap (ä¿ç•™æ›è¡Œ)ï¼Œæ²’å…§å®¹å‰‡ç”¨ä¸€èˆ¬æ’ç‰ˆé¡¯ç¤ºæç¤ºå­—
        const noteDisplayClass = notes ? 'whitespace-pre-wrap text-theme-text' : 'text-gray-400 italic';
        const noteDisplayText = notes ? notes : 'é»æ“Šä¸‹æ–¹ã€Œç·¨è¼¯è³‡æ–™ã€å³å¯æ–°å¢å‚™è¨»...';

        html += `
            <div class="glass-panel rounded-2xl p-5 border-l-4 border-l-purple-400 mb-6 shadow-sm">
                <h3 class="font-bold text-theme-text text-sm mb-2 flex items-center gap-2">
                    <i data-lucide="notebook-pen" class="w-4 h-4 text-purple-500"></i> ç®¡ç†å“¡å‚™è¨»
                </h3>
                <div class="view-mode text-sm min-h-[20px] leading-relaxed ${noteDisplayClass}">${noteDisplayText}</div>
                <textarea data-key="notes" class="edit-mode hidden input-minimal w-full h-24 text-sm resize-none focus:ring-2 focus:ring-purple-200" placeholder="è«‹è¼¸å…¥å‚™è¨»äº‹é …...">${notes}</textarea>
            </div>
        `;
        
        // --- å…¶ä»–è³‡æ–™å€å¡Š ---
        sections.forEach(section => {
            html += `
                <div class="glass-panel rounded-2xl overflow-hidden mb-4 border border-white/60">
                    <div class="bg-theme-rose/5 px-5 py-3 border-b border-theme-rose/10">
                        <h3 class="font-bold text-theme-text text-sm">${section.title}</h3>
                    </div>
                    <div class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
            `;
            
            section.fields.forEach(f => {
                let val = currentItem[f.key];
                if (val === null || val === undefined) val = '-';
                if(f.suffix && val !== '-') val += f.suffix;
                
                const colSpan = f.full ? 'sm:col-span-2' : '';
                
                let displayVal = val;
                if (f.isTag && val !== '-' && typeof val === 'string') {
                    displayVal = val.split(',').map(v => 
                        `<span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-500 text-xs font-bold mr-1">${v}</span>`
                    ).join('');
                } else if (f.highlight === true || val === f.highlight) {
                    displayVal = `<span class="text-theme-rose font-bold">${val}</span>`;
                }

                html += `
                    <div class="${colSpan}">
                        <label class="block text-[10px] font-bold text-theme-sub mb-1 uppercase tracking-wider">${f.label}</label>
                        <div class="view-mode text-sm font-bold text-theme-text min-h-[24px] flex items-center">
                            ${displayVal}
                        </div>
                        <input type="text" data-key="${f.key}" value="${currentItem[f.key] || ''}" 
                            class="edit-mode hidden input-minimal py-1.5 px-3 text-sm h-9">
                    </div>
                `;
            });
            html += `</div></div>`;
        });

        if (currentItem.signature_data) {
            html += `
                <div class="glass-panel rounded-2xl p-5 border border-white/60 mt-4">
                    <h3 class="font-bold text-theme-text text-sm mb-3">âœï¸ é›»å­ç°½å</h3>
                    <div class="bg-white/50 rounded-xl p-4 border border-dashed border-theme-sub/20 flex justify-center">
                        <img src="${currentItem.signature_data}" class="max-h-24 object-contain">
                    </div>
                </div>
            `;
        }

        content.innerHTML = html;
        lucide.createIcons();

        document.getElementById('btn-edit').classList.remove('hidden');
        document.getElementById('btn-save').classList.add('hidden');
        
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            panel.classList.remove('translate-y-full');
        }, 10);
    }


    // é—œé–‰è©³æƒ…å½ˆçª—
    function closeModal() {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.add('opacity-0');
        panel.classList.add('translate-y-full');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
    function enableEdit() {
        document.getElementById('btn-edit').classList.add('hidden');
        document.getElementById('btn-save').classList.remove('hidden');
        
        document.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
        
        showToast('å·²é€²å…¥ç·¨è¼¯æ¨¡å¼', 'success');
    }

    // --- æ–°å¢ï¼šå®‰å…¨é©—è­‰é‚è¼¯ ---

    // é–‹å•Ÿé©—è­‰å½ˆçª— (æ¥æ”¶å‹•ä½œé¡å‹ï¼š'save' æˆ– 'delete')
    function showAuthModal(actionType) {
        pendingAction = actionType; // è¨­å®šå¾…åŸ·è¡Œçš„å‹•ä½œ
        
        const titleEl = document.getElementById('auth-title');
        const descEl = document.getElementById('auth-desc');
        
        // æ ¹æ“šå‹•ä½œé¡å‹é¡¯ç¤ºä¸åŒæ¨™é¡Œ
        if (actionType === 'save') {
            titleEl.innerText = 'å®‰å…¨é©—è­‰';
            descEl.innerText = 'ä¿®æ”¹æ•æ„Ÿè³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        } else if (actionType === 'delete') {
            titleEl.innerText = 'åˆªé™¤ç¢ºèª';
            descEl.innerText = 'åˆªé™¤æ­¤ç­†è³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        }

        document.getElementById('auth-password').value = ''; // æ¸…ç©ºå¯†ç¢¼
        
        const modal = document.getElementById('auth-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        
        // è‡ªå‹•èšç„¦
        setTimeout(() => document.getElementById('auth-password').focus(), 100);
    }

// é—œé–‰é©—è­‰å½ˆçª—
    function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            // pendingAction = null; // é€™è¡Œå¯ä»¥è¨»è§£æ‰æˆ–åˆªé™¤ï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“åœ¨ handleAuthConfirm è™•ç†éäº†
        }, 300);
        // å¦‚æœä½ å¸Œæœ›ä¿æŒè¦–çª—é—œé–‰å°±æ¸…ç©ºï¼Œé€™è¡Œä¿ç•™ä¹Ÿæ²’é—œä¿‚ï¼Œå› ç‚ºä¸Šé¢çš„ handleAuthConfirm å·²ç¶“ä¿®å¥½äº†
        pendingAction = null; 
    }

// è™•ç†é©—è­‰ç¢ºèª
    async function handleAuthConfirm() {
        const btn = document.getElementById('auth-confirm-btn');
        const originalText = btn.innerHTML;
        const password = document.getElementById('auth-password').value;
        
        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // é©—è­‰å¯†ç¢¼
            const { error } = await _supabase.auth.signInWithPassword({
                email: 'elvira5201314@gmail.com', // è«‹ç¢ºèªé€™è£¡æ˜¯ç”¨æˆ¶è³‡æ–™åº«è£¡æœ‰çš„ email
                password: password
            });

            if (error) throw error;

            // â˜… ä¿®æ­£é»ï¼šå…ˆå°‡å‹•ä½œå­˜åˆ°å€åŸŸè®Šæ•¸ï¼Œé¿å… closeAuthModal æŠŠ pendingAction æ¸…ç©ºå¾ŒæŠ“ä¸åˆ°
            const action = pendingAction;

            // é©—è­‰æˆåŠŸï¼Œé—œé–‰è¦–çª—
            closeAuthModal();
            
            // åŸ·è¡Œå°æ‡‰å‡½å¼ (æ”¹ç”¨å‰›å‰›å­˜ä¸‹ä¾†çš„ action è®Šæ•¸)
            setTimeout(() => {
                if (action === 'save') executeSave();
                else if (action === 'delete') executeDelete();
            }, 300);

        } catch (error) {
            console.error(error);
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // å¼·åˆ¶ä¿®æ­£å„²å­˜æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ (ç¢ºä¿æŒ‰éˆ•å‘¼å« saveChanges)
    document.addEventListener('DOMContentLoaded', () => {
        const saveBtn = document.getElementById('btn-save');
        if (saveBtn) {
            saveBtn.removeAttribute('onclick');
            saveBtn.onclick = saveChanges;
        }
    });

    // é»æ“Šã€Œå„²å­˜è®Šæ›´ã€æŒ‰éˆ• (æª¢æŸ¥è®Šæ›´å…§å®¹)
    function saveChanges() {
        let sensitiveChanged = false;
        let notesChanged = false;
        let hasChanges = false;

        document.querySelectorAll('.edit-mode').forEach(input => {
            const key = input.dataset.key;
            if (!key) return;
            
            let originalValue = currentItem[key];
            if (originalValue === null || originalValue === undefined) originalValue = '';
            
            let newValue = input.value;
            
            if (String(originalValue).trim() !== String(newValue).trim()) {
                hasChanges = true;
                if (key === 'notes') {
                    notesChanged = true;
                } else {
                    sensitiveChanged = true;
                }
            }
        });

        if (!hasChanges) {
            showToast('æœªåµæ¸¬åˆ°ä»»ä½•è®Šæ›´', 'info');
            // å¦‚æœæ²’è®Šæ›´ï¼Œé‡æ–°è¼‰å…¥ Modal å›åˆ°æª¢è¦–æ¨¡å¼
            openModal(currentItem.id);
            return;
        }

        if (sensitiveChanged) {
            // æ”¹äº†æ•æ„Ÿè³‡æ–™ -> å‚³å…¥ 'save' å­—ä¸²å‘Šè¨´ Modal é€™æ˜¯å„²å­˜å‹•ä½œ
            showAuthModal('save');
        } else {
            // åªæ”¹å‚™è¨» -> ç›´æ¥å­˜
            executeSave();
        }
    }

    // é»æ“Šã€Œåˆªé™¤ã€æŒ‰éˆ•
    function requestDelete() {
        // å‚³å…¥ 'delete' å­—ä¸²å‘Šè¨´ Modal é€™æ˜¯åˆªé™¤å‹•ä½œ
        showAuthModal('delete');
    }

    // çœŸæ­£çš„å„²å­˜åŸ·è¡Œå‡½å¼
    async function executeSave() {
        const btn = document.getElementById('btn-save');
        if (!btn) return;
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> å„²å­˜ä¸­...';
            btn.disabled = true;
            lucide.createIcons();

            const updates = {};
            document.querySelectorAll('.edit-mode').forEach(input => {
                const key = input.dataset.key;
                if (key) updates[key] = input.value;
            });

            const { error } = await _supabase
                .from('service_contracts')
                .update(updates)
                .eq('id', currentItem.id);

            if (error) throw error;

            showToast('è³‡æ–™å·²æ›´æ–°', 'success');
            closeModal();
            loadData();

        } catch (error) {
            console.error('Save Error:', error);
            showToast('å„²å­˜å¤±æ•—: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // åŸ·è¡Œåˆªé™¤
    async function executeDelete() {
        const { error } = await _supabase
            .from('service_contracts')
            .delete()
            .eq('id', currentItem.id);

        if (error) {
            showToast('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
        } else {
            showToast('å·²åˆªé™¤è©²ç­†è³‡æ–™', 'success');
            closeModal();
            loadData();
        }
    }

    // Toast æç¤º
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        const bgClass = type === 'success' ? 'bg-[#06C755]' : 'bg-red-500';
        const icon = type === 'success' ? 'check-circle' : 'alert-circle';
        
        el.className = `${bgClass} text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 transform translate-y-[-20px] opacity-0 transition-all duration-300 font-bold tracking-wide`;
        el.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i> ${message}`;
        
        container.appendChild(el);
        lucide.createIcons();

        requestAnimationFrame(() => {
            el.classList.remove('translate-y-[-20px]', 'opacity-0');
        });

        setTimeout(() => {
            el.classList.add('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    }

    // é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆçª—
    document.getElementById('detail-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('detail-modal')) closeModal();
    });
</script>
</body>
</html>

